
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrderFlow OMS - 独立预览版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Lucide Icons UMD -->
  <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide-react.js"></script>
  <!-- Babel for in-browser JSX compilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
    .font-handwriting { font-family: 'Dancing Script', cursive; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="typescript,react">
    const { useState, useEffect, useMemo } = React;
    
    // Destructure Icons from global lucideReact
    const { 
      Search, Plus, Truck, RotateCcw, RefreshCw, DollarSign, Edit, Edit2, Filter, FileCheck, 
      LayoutDashboard, ClipboardList, Menu, CheckCircle, XCircle, Clock, ChevronRight, ChevronLeft,
      ChevronUp, ChevronDown, FileText, Banknote, ScrollText, QrCode, Archive, Box, Home, 
      TrendingUp, TrendingDown, ShoppingCart, Package, Gavel, List, Send, History, Globe, 
      User, AlertCircle, Calendar, Paperclip, ArrowRight, Settings, AlignCenter, Scale, 
      LogIn, LogOut, PackageCheck, Activity, ShoppingBag, PieChart, Printer, ScanLine, 
      ArrowDownCircle, ArrowUpCircle, ClipboardCheck, Smartphone, Trash2, Layers, Download, RefreshCcw, 
      Shield, PenTool, Camera, AlertTriangle, Save, Factory, X, Clipboard, BarChart2
    } = lucideReact;

    // --- ENUMS & TYPES ---
    enum OrderStatus {
      PendingAudit = '待审核',
      PriceApproval = '调价审批中',
      Unassigned = '未分配车辆',
      ReadyToShip = '待发货',
      Shipping = '发货中',
      Receiving = '收货中',
      Completed = '已完成',
      Stored = '已入库',
      Returning = '退货中',
      Exchanging = '换货中',
      Returned = '已退货',
      Exchanged = '已换货',
    }

    enum VehicleStatus {
      PendingEntry = '待入厂',
      Entered = '已入厂',
      Loading = '装货中',
      Unloading = '卸货中',
      Exited = '已出厂',
    }

    enum RecordType {
      Normal = '正常出货',
      Return = '退货',
      Exchange = '换货',
    }

    enum ContractType {
      Purchase = '采购合同',
      Sales = '销售合同'
    }

    enum ContractStatus {
      New = '新增',
      Shipping = '发货中',
      Completed = '已完成'
    }

    enum WarehouseType {
      RawMaterial = '原料仓',
      SemiFinished = '半成品仓',
      Finished = '成品仓'
    }

    interface StockRecord {
      id: string;
      date: string;
      type: 'in' | 'out' | 'transfer' | 'adjust';
      product: string;
      qty: number;
      ref: string;
      plate?: string;
      materialType?: 'finished' | 'semi';
    }

    // --- MOCK CONSTANTS ---
    const generateHistory = (status) => [
      { date: '2023-10-20 09:00', action: '创建订单', user: '销售部-李经理' },
      { date: '2023-10-20 10:30', action: `状态更新: ${status}`, user: '物流部-王调度' },
    ];

    const MOCK_VEHICLE_POOL = [
      { id: 'v1', plateNumber: '鲁C88888', driverName: '张建国', driverPhone: '13800138000' },
      { id: 'v2', plateNumber: '鲁C66666', driverName: '李富贵', driverPhone: '13900139000' },
      { id: 'v3', plateNumber: '鲁Q12345', driverName: '王铁柱', driverPhone: '13700137000' },
      { id: 'v4', plateNumber: '冀B99999', driverName: '赵大力', driverPhone: '15000000000' },
      { id: 'v5', plateNumber: '豫K56789', driverName: '孙保国', driverPhone: '15100000000' },
      { id: 'v6', plateNumber: '苏G55555', driverName: '周发财', driverPhone: '15200000000' },
    ];

    const MOCK_CONTRACTS = [
      {
        id: 'c1', contractNumber: 'CON-2023-001', name: '申鼎商贸500吨|2023-10-20', signDate: '2023-10-20',
        customerName: '申鼎商贸', productName: '氟化铝', spec: 'GB/T4292-2017 AF-1', quantity: 500,
        amount: 3250000, deliveryTime: '2023-11-20', status: ContractStatus.Shipping, type: ContractType.Sales,
        owner: 'Admin User', attachment: '销售合同_001.pdf'
      },
      {
        id: 'c2', contractNumber: 'CON-2023-002', name: '奥鹏200吨|2023-10-22', signDate: '2023-10-22',
        customerName: '奥鹏', productName: '氟化铝', spec: '98% / 罐车', quantity: 200,
        amount: 90000, deliveryTime: '2023-11-22', status: ContractStatus.Shipping, type: ContractType.Sales,
        owner: 'Admin User', attachment: '销售合同_002.pdf'
      },
      {
        id: 'c3', contractNumber: 'PUR-2023-088', name: '原料采购-萤石1000吨|2023-10-25', signDate: '2023-10-25',
        customerName: '西部矿业', productName: '萤石', spec: '原矿', quantity: 1000,
        amount: 2800000, deliveryTime: '2023-12-01', status: ContractStatus.New, type: ContractType.Purchase,
        owner: 'Admin User'
      },
      {
        id: 'c4', contractNumber: 'PUR-2023-090', name: '原料采购-煤炭500吨|2023-10-28', signDate: '2023-10-28',
        customerName: '山西能源', productName: '无烟煤', spec: '块煤', quantity: 500,
        amount: 600000, deliveryTime: '2023-11-15', status: ContractStatus.Shipping, type: ContractType.Purchase,
        owner: 'Admin User'
      }
    ];

    const MOCK_ORDERS = [
      // SALES
      {
        id: 'ORD-20231029-000', type: 'sales', contractId: 'CON-NEW-000', customerName: '新希望集团', productName: '氟化铝', category: 'main',
        spec: '25kg/袋', quantity: 150, unitPrice: 3200, shipDate: '2023-10-29', status: OrderStatus.PendingAudit,
        vehicles: [], history: [{ date: '2023-10-29 08:30', action: '创建订单', user: '销售部-赵云' }],
      },
      {
        id: 'ORD-20231027-001', type: 'sales', contractId: 'CON-SD-001', customerName: '申鼎商贸', productName: '氟化铝', category: 'main',
        spec: 'GB/T4292-2017 AF-1', quantity: 500, unitPrice: 6500, shipDate: '2023-10-27', status: OrderStatus.ReadyToShip,
        vehicles: [
          { id: 'rec-1', plateNumber: '鲁C88888', driverName: '张建国', driverPhone: '13800138000', loadWeight: 32, status: VehicleStatus.PendingEntry, type: RecordType.Normal },
          { id: 'rec-2', plateNumber: '鲁C66666', driverName: '李富贵', driverPhone: '13900139000', loadWeight: 33, status: VehicleStatus.PendingEntry, type: RecordType.Normal }
        ],
        history: generateHistory(OrderStatus.ReadyToShip),
      },
      // PURCHASE
      {
        id: 'PUR-20231030-001',
        type: 'purchase',
        contractId: 'CON-SUP-001',
        customerName: '金石资源集团',
        productName: '萤石',
        category: 'main',
        spec: 'CaF2≥97%',
        quantity: 2000,
        unitPrice: 2800,
        shipDate: '2023-10-30',
        status: OrderStatus.Receiving,
        vehicles: [
           { id: 'pv-1', plateNumber: '蒙K88776', driverName: '王大雷', driverPhone: '13900001111', loadWeight: 33, status: VehicleStatus.Unloading, type: RecordType.Normal, entryTime: '2023-10-30 08:15', weighing1: { time: '08:25', weight: 48.5 } },
           { id: 'pv-2', plateNumber: '蒙K99887', driverName: '李二牛', driverPhone: '13900002222', loadWeight: 33, status: VehicleStatus.Entered, type: RecordType.Normal, entryTime: '2023-10-30 08:40' }
        ],
        history: generateHistory(OrderStatus.Receiving),
      },
      {
        id: 'PUR-20231030-002',
        type: 'purchase',
        contractId: 'CON-SUP-002',
        customerName: '鲁西化工',
        productName: '硫酸',
        category: 'main',
        spec: '98% 工业级',
        quantity: 500,
        unitPrice: 400,
        shipDate: '2023-10-30',
        status: OrderStatus.Stored,
        vehicles: [
           { id: 'pv-3', plateNumber: '鲁H12345', driverName: '赵铁柱', driverPhone: '13900003333', loadWeight: 30, status: VehicleStatus.Exited, actualOutWeight: 30.2, type: RecordType.Normal, entryTime: '2023-10-30 07:00', weighing1: {time: '07:10', weight: 45.2}, weighing2: {time: '08:00', weight: 15.0}, exitTime: '2023-10-30 08:10' }
        ],
        history: generateHistory(OrderStatus.Stored),
      },
      {
        id: 'PUR-20231029-003',
        type: 'purchase',
        contractId: 'CON-SUP-003',
        customerName: '中铝山东',
        productName: '氢氧化铝',
        category: 'main',
        spec: '干粉',
        quantity: 1000,
        unitPrice: 1800,
        shipDate: '2023-10-29',
        status: OrderStatus.Stored,
        vehicles: [
           { id: 'pv-4', plateNumber: '鲁C55667', driverName: '孙悟空', driverPhone: '13900004444', loadWeight: 35, status: VehicleStatus.Exited, actualOutWeight: 34.8, type: RecordType.Normal, entryTime: '2023-10-29 09:00', weighing1: {time: '09:15', weight: 50.8}, weighing2: {time: '10:30', weight: 16.0}, exitTime: '2023-10-29 10:45' }
        ],
        history: generateHistory(OrderStatus.Stored),
      }
    ];

    const MOCK_PRODUCT_RULES = [
      { id: 'r1', productName: '湿法氟化铝', exampleCode: 'FHL-20231027-0001', segments: [{ id: 's1', type: 'fixed', value: 'FHL-' }, { id: 's2', type: 'date', value: 'YYYYMMDD' }, { id: 's3', type: 'fixed', value: '-' }, { id: 's4', type: 'sequence', value: '4' }] },
      { id: 'r2', productName: '氧化铝', exampleCode: 'YHL-2310-00001', segments: [{ id: 's1', type: 'fixed', value: 'YHL-' }, { id: 's2', type: 'date', value: 'YYMM' }, { id: 's3', type: 'fixed', value: '-' }, { id: 's4', type: 'sequence', value: '5' }] },
    ];

    const MOCK_WAREHOUSES = [
      {
        id: 'w1', name: '1号原料库', type: WarehouseType.RawMaterial, createDate: '2023-01-10',
        zones: [
          { id: 'z1-1', name: 'A区', inventory: [{ id: 'i1', productName: '萤石', quantity: 500, unit: '吨', productCode: 'FLU20231027001', barcode: 'FLU20231027001' }] },
          { id: 'z1-2', name: 'B区', inventory: [] }
        ]
      },
      {
        id: 'w2', name: '半成品暂存库', type: WarehouseType.SemiFinished, createDate: '2023-02-20',
        zones: [
          { id: 'z2-1', name: 'S-01', inventory: [] },
          { id: 'z2-2', name: 'S-02', inventory: [] }
        ]
      },
      {
        id: 'w3', name: '成品发货仓', type: WarehouseType.Finished, createDate: '2023-03-15',
        zones: [
          { id: 'z3-1', name: 'F-01', inventory: [{ id: 'i2', productName: '湿法氟化铝', quantity: 1200, unit: '吨', productCode: 'FHL-20231027-0001', barcode: 'FHL-20231027-0001' }, { id: 'i3', productName: '氧化铝', quantity: 300, unit: '吨', productCode: 'YHL-2310-00001', barcode: 'YHL-2310-00001' }] },
          { id: 'z3-2', name: 'F-02', inventory: [] },
          { id: 'z3-3', name: 'F-03', inventory: [] }
        ]
      }
    ];

    const INITIAL_FORM_DATA = {
        id: '',
        senderUnit: '', roadTransportCert: '', transportUnit: '', businessLicense: '',
        mainPlate: '', trailerPlate: '', approvedLoad: '', unloadQty: '',
        driverName: '', driverId: '', escortName: '', escortId: '',
        qualificationCert: '', hazmatCert: '',
        triangleLight: true, reflectiveStrips: true, rectSign: true, emergencyKit: true,
        staticGrounding: true, baffles: true, hazmatSigns: true, cutoffValve: true, sparkArrestor: true,
        photoMatch: true, hoseIntact: true, hoseStored: false, valveClosed: false, leakCheck: false,
        analysisResult: '', tankId: '', levelBefore: '', levelAfter: '',
        startDcs1: '', startDcs2: '', startSite1: '', startSite2: '',
        endDcs1: '', endDcs2: '', endSite1: '', endSite2: '',
        remark: '', entryTime: '', exitTime: '', unloaderSign: '', supervisorSign: ''
    };

    const MOCK_SUBMISSIONS = [
      {
        ...INITIAL_FORM_DATA,
        id: 'SUB-001',
        senderUnit: '鲁西化工集团',
        mainPlate: '鲁C88888',
        driverName: '张建国',
        unloadQty: '32',
        entryTime: '2023-10-30 08:30',
        transportUnit: '及第物流',
        escortName: '李安全'
      },
      {
        ...INITIAL_FORM_DATA,
        id: 'SUB-002',
        senderUnit: '山东黄金冶炼厂',
        mainPlate: '冀B99999',
        driverName: '赵大力',
        unloadQty: '30',
        entryTime: '2023-10-30 09:15',
        transportUnit: '北方运输',
        escortName: '王保障'
      }
    ];

    // --- COMPONENTS ---
    
    // StatusBadge, Modals, etc. (Same as previous versions)
    const StatusBadge = ({ status, type = 'order' }) => {
      // ... same logic
      let colorClass = 'bg-gray-100 text-gray-800';
      if (type === 'order') {
        switch (status) {
          case OrderStatus.PendingAudit: colorClass = 'bg-purple-100 text-purple-800 border-purple-200'; break;
          case OrderStatus.PriceApproval: colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-200'; break;
          case OrderStatus.Unassigned: colorClass = 'bg-gray-100 text-gray-600 border-gray-200'; break;
          case OrderStatus.ReadyToShip: colorClass = 'bg-blue-100 text-blue-800 border-blue-200'; break;
          case OrderStatus.Shipping: colorClass = 'bg-indigo-100 text-indigo-800 border-indigo-200 animate-pulse'; break;
          case OrderStatus.Receiving: colorClass = 'bg-indigo-100 text-indigo-800 border-indigo-200 animate-pulse'; break;
          case OrderStatus.Completed: colorClass = 'bg-green-100 text-green-800 border-green-200'; break;
          case OrderStatus.Stored: colorClass = 'bg-green-100 text-green-800 border-green-200'; break;
          case OrderStatus.Returning: colorClass = 'bg-red-50 text-red-600 border-red-200'; break;
          case OrderStatus.Exchanging: colorClass = 'bg-orange-50 text-orange-600 border-orange-200'; break;
          case OrderStatus.Returned: colorClass = 'bg-red-100 text-red-800 border-red-200'; break;
          case OrderStatus.Exchanged: colorClass = 'bg-orange-100 text-orange-800 border-orange-200'; break;
        }
      } else {
        switch (status) {
          case VehicleStatus.PendingEntry: colorClass = 'bg-gray-100 text-gray-600'; break;
          case VehicleStatus.Entered: colorClass = 'bg-blue-50 text-blue-600'; break;
          case VehicleStatus.Loading:
          case VehicleStatus.Unloading: colorClass = 'bg-indigo-100 text-indigo-700'; break;
          case VehicleStatus.Exited: colorClass = 'bg-green-50 text-green-700'; break;
        }
      }
      return <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${colorClass}`}>{status}</span>;
    };

    // ... (Other Modals - omitted for brevity, logic identical to previous files) ...

    const WarehouseOverview = ({ extraRecords = [] }) => {
      const [warehouses, setWarehouses] = useState(MOCK_WAREHOUSES);
      const [expandedWh, setExpandedWh] = useState(MOCK_WAREHOUSES[0].id);
      const [detailTab, setDetailTab] = useState('inventory');
      const [localRecords, setLocalRecords] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [dateRange, setDateRange] = useState({ start: '', end: '' });
      const [isPdaOpen, setIsPdaOpen] = useState(false);
      const [pdaMode, setPdaMode] = useState('gen');
      const [pdaForm, setPdaForm] = useState({ product: '湿法氟化铝', date: new Date().toISOString().split('T')[0], line: '1号产线', warehouseId: '', zoneId: '', targetWarehouseId: '', targetZoneId: '', weight: '', plate: '', barcode: '', batchNo: '', adjType: 'add', materialType: 'finished' });
      const [transferStep, setTransferStep] = useState('scan');
      const [scannedSource, setScannedSource] = useState(null);

      useEffect(() => {
        const derivedRecords = [];
        MOCK_ORDERS.forEach(o => {
            o.vehicles.forEach((v, idx) => {
               if (v.actualOutWeight || v.loadWeight) {
                  derivedRecords.push({
                     id: `${o.id}-v${idx}`,
                     date: v.exitTime || o.shipDate + ' 12:00',
                     type: 'out',
                     product: o.productName,
                     qty: v.actualOutWeight || v.loadWeight,
                     ref: o.id,
                     plate: v.plateNumber,
                     materialType: 'finished'
                  });
               }
            });
        });
        MOCK_CONTRACTS.filter(c => c.type === ContractType.Purchase).forEach((c) => {
             derivedRecords.push({
                 id: `in-${c.id}`,
                 date: c.signDate + ' 09:30',
                 type: 'in',
                 product: c.productName,
                 qty: 35,
                 ref: c.contractNumber,
                 plate: '-', 
                 materialType: 'semi' 
             });
        });
        setLocalRecords([...derivedRecords, ...extraRecords].sort((a, b) => b.date.localeCompare(a.date)));
      }, [extraRecords]);

      const { displayedRecords, stats } = useMemo(() => {
         let recs = [...localRecords];
         if (expandedWh) {
            const wh = warehouses.find(w => w.id === expandedWh);
            if (wh) {
                recs = recs.filter(r => {
                    if (wh.type === '原料仓') return ['萤石', '煤炭', '原矿', '硫酸'].some(p => r.product.includes(p));
                    if (wh.type === '成品仓') return ['氟化铝', '氧化铝'].some(p => r.product.includes(p));
                    if (wh.type === '半成品仓') return ['氢氧化铝', '半成品'].some(p => r.product.includes(p));
                    return true; 
                });
            }
         }
         if (searchTerm) {
            recs = recs.filter(r => r.product.includes(searchTerm) || r.plate?.includes(searchTerm));
         }
         if (dateRange.start) {
            recs = recs.filter(r => r.date >= dateRange.start);
         }
         if (dateRange.end) {
            recs = recs.filter(r => r.date <= dateRange.end + ' 23:59:59');
         }

         const totalIn = recs.filter(r => r.type === 'in' || (r.type === 'adjust' && r.qty > 0)).reduce((acc, r) => acc + Math.abs(r.qty), 0);
         const totalOut = recs.filter(r => r.type === 'out' || (r.type === 'adjust' && r.qty < 0)).reduce((acc, r) => acc + Math.abs(r.qty), 0);

         recs.sort((a, b) => b.date.localeCompare(a.date));
         return { displayedRecords: recs, stats: { totalIn, totalOut } };
      }, [expandedWh, localRecords, warehouses, searchTerm, dateRange]);

      const resetPdaForm = () => {
         setPdaForm(prev => ({ ...prev, warehouseId: '', zoneId: '', targetWarehouseId: '', targetZoneId: '', weight: '', plate: '', barcode: '' }));
         setTransferStep('scan');
         setScannedSource(null);
      };

      const generateCode = () => {
         const code = `${pdaForm.product}-${pdaForm.date.replace(/-/g,'')}-${pdaForm.line}-${Math.floor(Math.random()*1000)}`;
         setPdaForm({...pdaForm, barcode: code});
      };

      const handleTransferScan = () => {
         if (!pdaForm.barcode) return alert('请输入或扫描条码');
         let found = null;
         for (const w of warehouses) {
            for (const z of w.zones) {
               const item = z.inventory.find(i => i.barcode === pdaForm.barcode || i.productCode === pdaForm.barcode);
               if (item) {
                  found = { warehouseId: w.id, warehouseName: w.name, zoneId: z.id, zoneName: z.name, product: item.productName, currentQty: item.quantity, barcode: item.barcode };
                  break;
               }
            }
            if (found) break;
         }
         if (found) { setScannedSource(found); setPdaForm(prev => ({ ...prev, product: found.product, warehouseId: found.warehouseId, zoneId: found.zoneId })); setTransferStep('confirm'); } else { alert('未找到该条码对应的库存记录'); }
      };

      const handlePdaSubmit = () => {
         const weightVal = parseFloat(pdaForm.weight) || 0;
         const now = new Date().toLocaleString('zh-CN', {hour12: false});
         // ... Simplified logic for preview ...
         if(pdaMode === 'in') { alert('入库成功'); }
         if(pdaMode === 'out') { alert('出库成功'); }
         if(pdaMode === 'transfer') { alert('调拨成功'); }
         if(pdaMode === 'count') { alert('盘点成功'); }
         resetPdaForm();
      };

      return (
        <div>
           <div className="flex justify-between items-end mb-6">
             <h2 className="text-2xl font-bold text-gray-800">仓库概览</h2>
             <button onClick={() => setIsPdaOpen(true)} className="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg text-sm"><Smartphone size={18}/> PDA作业</button>
           </div>

           <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                {warehouses.map(wh => {
                    const isExpanded = expandedWh === wh.id;
                    const totalItems = wh.zones.reduce((acc, z) => acc + z.inventory.length, 0);
                    const totalQty = wh.zones.reduce((acc, z) => acc + z.inventory.reduce((q, i) => q + i.quantity, 0), 0);
                    return (
                    <div key={wh.id} onClick={() => { setExpandedWh(wh.id); setDetailTab('inventory'); }} className={`cursor-pointer rounded-xl border p-5 transition-all ${isExpanded ? 'bg-indigo-50 border-indigo-200 ring-2 ring-indigo-100' : 'bg-white border-gray-200 hover:shadow-md'}`}>
                        <div className="flex items-center gap-3 mb-3">
                            <div className={`p-2 rounded-lg ${isExpanded ? 'bg-indigo-200 text-indigo-700' : 'bg-gray-100 text-gray-600'}`}><Box size={24} /></div>
                            <div><h3 className={`font-bold text-lg ${isExpanded ? 'text-indigo-900' : 'text-gray-800'}`}>{wh.name}</h3><div className="text-xs text-gray-500">{wh.type}</div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-sm"><div className="bg-white/50 p-2 rounded"><div className="text-gray-500 text-xs">库存批次</div><div className="font-bold text-gray-800">{totalItems} 批</div></div><div className="bg-white/50 p-2 rounded"><div className="text-gray-500 text-xs">总数量</div><div className="font-bold text-gray-800">{totalQty} 吨</div></div></div>
                    </div>
                    );
                })}
           </div>

           {expandedWh && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 min-h-[400px]">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Box className="text-indigo-500"/>{warehouses.find(w => w.id === expandedWh)?.name}</h3>
                        <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => setDetailTab('inventory')} className={`px-4 py-1.5 rounded-md text-sm font-medium ${detailTab === 'inventory' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500'}`}>区域库存</button>
                            <button onClick={() => setDetailTab('records')} className={`px-4 py-1.5 rounded-md text-sm font-medium ${detailTab === 'records' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500'}`}>出入库记录</button>
                        </div>
                    </div>
                    {detailTab === 'records' && (
                        <div className="animate-in fade-in">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-green-50 rounded-lg p-3 border border-green-100"><div className="text-xs text-green-600 font-bold uppercase">期间总入库</div><div className="text-xl font-bold text-gray-800 mt-1">+{stats.totalIn.toFixed(1)} 吨</div></div>
                                <div className="bg-orange-50 rounded-lg p-3 border border-orange-100"><div className="text-xs text-orange-600 font-bold uppercase">期间总出库</div><div className="text-xl font-bold text-gray-800 mt-1">-{stats.totalOut.toFixed(1)} 吨</div></div>
                                <div className="bg-blue-50 rounded-lg p-3 border border-blue-100"><div className="text-xs text-blue-600 font-bold uppercase">净变动</div><div className={`text-xl font-bold mt-1 ${(stats.totalIn - stats.totalOut) >= 0 ? 'text-green-600' : 'text-red-600'}`}>{(stats.totalIn - stats.totalOut) > 0 ? '+' : ''}{(stats.totalIn - stats.totalOut).toFixed(1)} 吨</div></div>
                            </div>
                            <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <div className="flex items-center gap-2 bg-gray-50 p-1 rounded-lg border">
                                    <div className="flex items-center px-2 gap-2 border-r border-gray-200 pr-3">
                                        <input type="date" className="bg-transparent text-sm text-gray-600 outline-none" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})}/>
                                        <span className="text-gray-400">-</span>
                                        <input type="date" className="bg-transparent text-sm text-gray-600 outline-none" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})}/>
                                    </div>
                                    <div className="flex items-center px-2 gap-2">
                                        <Search size={14} className="text-gray-400" />
                                        <input type="text" placeholder="搜索产品..." className="bg-transparent text-sm w-40 outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                                    </div>
                                </div>
                                <div className="flex gap-2 text-xs text-gray-500 self-center">显示 {displayedRecords.length} 条记录</div>
                            </div>
                            <div className="border rounded-lg overflow-hidden">
                                <table className="min-w-full divide-y divide-gray-100">
                                    <thead className="bg-gray-50"><tr><th className="p-3 text-left">时间</th><th className="p-3 text-left">类型</th><th className="p-3 text-left">产品</th><th className="p-3 text-left">数量</th><th className="p-3 text-left">摘要</th></tr></thead>
                                    <tbody>
                                    {displayedRecords.slice(0, 10).map(r => (
                                        <tr key={r.id} className="hover:bg-gray-50">
                                            <td className="p-3 text-xs text-gray-500">{r.date}</td>
                                            <td className="p-3"><span className={`px-2 py-0.5 rounded text-xs ${r.type==='in'?'bg-green-100':r.type==='out'?'bg-orange-100':'bg-blue-100'}`}>{r.type}</span></td>
                                            <td className="p-3 text-sm">{r.product}</td>
                                            <td className="p-3 text-sm font-bold">{r.qty}</td>
                                            <td className="p-3 text-xs text-gray-500">{r.ref}</td>
                                        </tr>
                                    ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    {detailTab === 'inventory' && (
                        <div className="space-y-6 animate-in fade-in">
                            {warehouses.find(w => w.id === expandedWh)?.zones.map(zone => (
                                <div key={zone.id} className="border rounded-lg overflow-hidden">
                                    <div className="bg-gray-50 px-4 py-2 border-b flex justify-between items-center"><span className="font-bold text-gray-700">{zone.name}</span></div>
                                    {zone.inventory.length === 0 ? <div className="p-4 text-center text-gray-400 text-sm">暂无库存</div> : 
                                    <table className="min-w-full divide-y divide-gray-100"><thead className="bg-white"><tr><th className="px-4 py-2 text-left text-xs font-medium text-gray-500">产品</th><th className="px-4 py-2 text-left text-xs font-medium text-gray-500">数量</th><th className="px-4 py-2 text-left text-xs font-medium text-gray-500">条码</th></tr></thead><tbody>
                                        {zone.inventory.map(item => (<tr key={item.id} className="hover:bg-gray-50"><td className="px-4 py-2 text-sm text-gray-900 font-medium">{item.productName}</td><td className="px-4 py-2 text-sm text-indigo-600 font-bold">{item.quantity} {item.unit}</td><td className="px-4 py-2 text-xs font-mono">{item.barcode}</td></tr>))}
                                    </tbody></table>}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
           )}

           {isPdaOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
               <div className="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border border-gray-200 flex flex-col h-[85vh]">
                  <div className="bg-white p-4 flex justify-between items-center border-b border-gray-100">
                     <span className="font-bold text-gray-800">PDA 手持终端模拟</span>
                     <button onClick={() => setIsPdaOpen(false)} className="text-gray-500 hover:text-gray-700"><X size={18} /></button>
                  </div>
                  <div className="p-2 grid grid-cols-5 gap-1 bg-gray-50 border-b border-gray-200">
                     {['gen', 'in', 'out', 'transfer', 'count'].map((m) => (
                        <button key={m} onClick={() => { setPdaMode(m); resetPdaForm(); }} className={`flex flex-col items-center justify-center p-2 rounded-lg text-xs font-medium ${pdaMode === m ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-white hover:text-gray-800'}`}>
                           <span>{m}</span>
                        </button>
                     ))}
                  </div>
                  <div className="flex-1 overflow-y-auto p-5 text-gray-800 space-y-5 bg-white">
                     <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-4">
                        <h4 className="text-gray-500 text-xs font-bold uppercase mb-2">当前模式: {pdaMode}</h4>
                        <input type="text" className="w-full bg-white border border-gray-300 rounded-lg p-2.5" placeholder="扫描条码..." value={pdaForm.barcode} onChange={e=>setPdaForm({...pdaForm, barcode:e.target.value})} />
                        <input type="number" className="w-full bg-white border border-gray-300 rounded-lg p-2.5" placeholder="数量/重量" value={pdaForm.weight} onChange={e=>setPdaForm({...pdaForm, weight:e.target.value})} />
                        <button onClick={handlePdaSubmit} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md">确认提交</button>
                     </div>
                  </div>
               </div>
            </div>
           )}
        </div>
      );
    };

    const WarehouseOperations = ({ onSaveRecord }) => {
      const [activeTab, setActiveTab] = useState('in');
      const [warehouses, setWarehouses] = useState(MOCK_WAREHOUSES);
      const [formData, setFormData] = useState({ product: '湿法氟化铝', batchNo: '', warehouseId: '', zoneId: '', targetWarehouseId: '', targetZoneId: '', weight: '', plate: '', outType: 'finished', adjType: 'add' });

      const availableInventory = useMemo(() => {
        const items = [];
        warehouses.forEach(w => w.zones.forEach(z => z.inventory.forEach(i => items.push({ whName: w.name, zoneName: z.name, product: i.productName, qty: i.quantity, barcode: i.barcode, label: `${w.name}-${z.name} | ${i.productName} (${i.quantity}T) [${i.barcode}]` }))));
        return items;
      }, [warehouses]);

      const handleSubmit = () => {
        const qty = parseFloat(formData.weight);
        if (!qty) return alert('请输入数量');
        alert(`操作成功 (Demo)`);
        setFormData({ ...formData, weight: '' });
      };

      const InputSection = ({ title, children }) => (
          <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
              <h3 className="text-sm font-bold text-gray-800 mb-4 pb-2 border-b">{title}</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{children}</div>
          </div>
      );

      return (
        <div className="max-w-6xl mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">库存作业 (PC端)</h2>
            <div className="bg-white p-1 rounded-xl shadow-sm border inline-flex mb-6">
                {['in', 'out', 'transfer', 'count'].map(t => (
                    <button key={t} onClick={() => setActiveTab(t)} className={`px-6 py-2.5 rounded-lg text-sm font-medium ${activeTab === t ? 'bg-blue-50 text-blue-700' : 'text-gray-500'}`}>
                        {t === 'in' ? '入库' : t === 'out' ? '出库' : t === 'transfer' ? '移库' : '盘点'}
                    </button>
                ))}
            </div>
            
            {activeTab === 'in' && (
                <InputSection title="入库">
                    <select className="w-full border rounded p-2" value={formData.warehouseId} onChange={e => setFormData({...formData, warehouseId: e.target.value})}>
                        <option value="">选择仓库</option>
                        {warehouses.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                    </select>
                    <input type="number" placeholder="数量" className="w-full border rounded p-2" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} />
                    <button onClick={handleSubmit} className="bg-green-600 text-white px-4 py-2 rounded">确认</button>
                </InputSection>
            )}
            
            {activeTab === 'out' && (
                <InputSection title="出库">
                    <div className="col-span-full flex gap-4 mb-2">
                        <label><input type="radio" checked={formData.outType==='finished'} onChange={()=>setFormData({...formData, outType: 'finished'})}/> 成品出库</label>
                        <label><input type="radio" checked={formData.outType==='semi'} onChange={()=>setFormData({...formData, outType: 'semi'})}/> 半成品出库</label>
                    </div>
                    <select className="w-full border rounded p-2 col-span-2" value={formData.batchNo} onChange={e => setFormData({...formData, batchNo: e.target.value})}>
                        <option value="">选择库存记录</option>
                        {availableInventory.map((i, idx) => <option key={idx} value={i.barcode}>{i.label}</option>)}
                    </select>
                    <input type="number" placeholder="数量" className="w-full border rounded p-2" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} />
                    <button onClick={handleSubmit} className="bg-orange-600 text-white px-4 py-2 rounded">确认</button>
                </InputSection>
            )}

            {activeTab === 'transfer' && (
                <InputSection title="移库">
                    <select className="w-full border rounded p-2 col-span-2" value={formData.batchNo} onChange={e => setFormData({...formData, batchNo: e.target.value})}>
                        <option value="">选择源库存</option>
                        {availableInventory.map((i, idx) => <option key={idx} value={i.barcode}>{i.label}</option>)}
                    </select>
                    <select className="w-full border rounded p-2" value={formData.targetWarehouseId} onChange={e => setFormData({...formData, targetWarehouseId: e.target.value})}>
                        <option value="">移入仓库</option>
                        {warehouses.map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                    </select>
                    <input type="number" placeholder="数量" className="w-full border rounded p-2" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} />
                    <button onClick={handleSubmit} className="bg-blue-600 text-white px-4 py-2 rounded">确认</button>
                </InputSection>
            )}

             {activeTab === 'count' && (
                <InputSection title="盘点">
                    <select className="w-full border rounded p-2 col-span-2" value={formData.batchNo} onChange={e => setFormData({...formData, batchNo: e.target.value})}>
                        <option value="">选择库存记录</option>
                        {availableInventory.map((i, idx) => <option key={idx} value={i.barcode}>{i.label}</option>)}
                    </select>
                    <input type="number" placeholder="差异数量" className="w-full border rounded p-2" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} />
                    <button onClick={handleSubmit} className="bg-purple-600 text-white px-4 py-2 rounded">确认</button>
                </InputSection>
            )}
        </div>
      );
    };

    const AppSimulation = ({ onSaveProduction, pendingTasks = [], onApprove, onReject }) => {
      const [view, setView] = useState('home');
      const [submissions, setSubmissions] = useState(MOCK_SUBMISSIONS);
      const [formData, setFormData] = useState(INITIAL_FORM_DATA);
      const [prodForm, setProdForm] = useState({
        batchNo: `BATCH-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-01`,
        date: new Date().toISOString().split('T')[0],
        line1: { output: '', fluorite: '', sulf98: '', sulf105: '' },
        line2: { output: '', fluorite: '', sulf98: '', sulf105: '' },
      });

      const handleInputChange = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      const handleProdChange = (line, field, value) => {
        setProdForm(prev => ({ ...prev, [line]: { ...prev[line], [field]: value } }));
      };

      const handleDriverSubmit = () => {
        if(formData.id) {
            setSubmissions(prev => prev.map(s => s.id === formData.id ? { ...formData, entryTime: s.entryTime } : s));
            alert('修改保存成功！');
            setView('staff-list');
        } else {
            const newSubmission = { ...formData, id: `SUB-${Date.now()}`, entryTime: new Date().toLocaleString('zh-CN', { hour12: false }) };
            setSubmissions(prev => [newSubmission, ...prev]);
            alert('提交成功！');
            setView('home');
        }
        setFormData(INITIAL_FORM_DATA);
      };

      const handleStaffSelect = (sub) => {
        setFormData(sub);
        setView('staff-detail');
      };

      const handleEditSubmission = (e, sub) => {
        e.stopPropagation();
        setFormData(sub);
        setView('driver');
      };

      const handleDeleteSubmission = (e, id) => {
        e.stopPropagation();
        if(confirm('删除此条记录？')) {
            setSubmissions(prev => prev.filter(s => s.id !== id));
        }
      };

      const handleStaffApprove = () => {
        setSubmissions(prev => prev.filter(s => s.id !== formData.id));
        alert('核准完成！');
        setFormData(INITIAL_FORM_DATA);
        setView('staff-list');
      };

      const handleSaveProd = () => {
        if (!onSaveProduction) return;
        const records = [];
        const now = new Date().toLocaleString('zh-CN', { hour12: false });
        const ref = `生产消耗-${prodForm.batchNo}`;
        const addRec = (product, qtyStr) => {
          const qty = parseFloat(qtyStr);
          if (qty > 0) records.push({ id: `prod-${Date.now()}-${Math.random()}`, date: now, type: 'out', product, qty, ref, plate: '-', materialType: 'semi' });
        };
        addRec('萤石', prodForm.line1.fluorite);
        addRec('98%硫酸', prodForm.line1.sulf98);
        addRec('105%硫酸', prodForm.line1.sulf105);
        addRec('萤石', prodForm.line2.fluorite);
        addRec('98%硫酸', prodForm.line2.sulf98);
        addRec('105%硫酸', prodForm.line2.sulf105);
        onSaveProduction(records);
        alert('生产日报已提交！');
        setView('home');
      };

      const InputRow = ({ label, field, type="text", placeholder="" }) => (
          <div className="mb-3">
              <label className="block text-xs text-gray-500 mb-1">{label}</label>
              <input 
                type={type}
                className="w-full border-b border-gray-200 py-1 text-sm focus:outline-none focus:border-blue-500 bg-transparent"
                value={formData[field]}
                onChange={(e) => handleInputChange(field, e.target.value)}
                placeholder={placeholder}
              />
          </div>
      );

      // --- New Mobile Stats View ---
      const StatisticsView = () => {
          const stats = useMemo(() => {
              const salesOrders = MOCK_ORDERS.filter(o => o.type === 'sales');
              const totalRevenue = salesOrders.reduce((acc, o) => acc + (o.quantity * o.unitPrice), 0);
              const totalTons = salesOrders.reduce((acc, o) => acc + o.quantity, 0);
              const dailyData = {};
              salesOrders.forEach(o => {
                  dailyData[o.shipDate] = (dailyData[o.shipDate] || 0) + (o.quantity * o.unitPrice);
              });
              const trend = Object.entries(dailyData).sort().slice(-7).map(([date, val]) => ({ date: date.slice(5), val }));
              return { totalRevenue, totalTons, trend };
          }, []);
          const maxValue = Math.max(...stats.trend.map(t => t.val), 100);

          return (
            <div className="h-full bg-gray-50 flex flex-col">
                <div className="bg-indigo-600 text-white px-4 py-3 flex items-center gap-3 shadow-md sticky top-0 z-10">
                    <button onClick={() => setView('home')}><ChevronLeft /></button>
                    <h2 className="font-bold text-lg">经营统计</h2>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    <div className="bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl p-5 text-white shadow-lg">
                        <div className="text-indigo-100 text-sm mb-1">本月累计销售</div>
                        <div className="text-3xl font-bold">¥{(stats.totalRevenue / 10000).toFixed(2)}w</div>
                        <div className="flex gap-4 mt-4 text-xs font-medium text-indigo-100">
                            <div className="bg-white/20 px-2 py-1 rounded">销量: {stats.totalTons}吨</div>
                            <div className="bg-white/20 px-2 py-1 rounded flex items-center gap-1"><TrendingUp size={12}/> 环比 +12%</div>
                        </div>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-800 text-sm mb-4 flex items-center gap-2"><TrendingUp size={16} className="text-blue-500"/> 近7日销售趋势</h3>
                        <div className="flex items-end justify-between h-32 gap-2">
                            {stats.trend.length > 0 ? stats.trend.map((d, i) => (
                                <div key={i} className="flex-1 flex flex-col items-center gap-1 group">
                                    <div className="w-full bg-blue-100 rounded-t-sm relative group-hover:bg-blue-200 transition-colors" style={{ height: `${(d.val / maxValue) * 100}%` }}></div>
                                    <div className="text-[10px] text-gray-400">{d.date}</div>
                                </div>
                            )) : <div className="w-full text-center text-gray-400 text-xs mt-10">暂无数据</div>}
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 text-sm font-bold text-gray-700">最新大额订单</div>
                        {MOCK_ORDERS.filter(o => o.type === 'sales').slice(0, 5).map(o => (
                            <div key={o.id} className="p-4 border-b border-gray-100 last:border-0 flex justify-between items-center">
                                <div><div className="font-bold text-gray-800 text-sm">{o.customerName}</div><div className="text-xs text-gray-500 mt-0.5">{o.productName} | {o.shipDate}</div></div>
                                <div className="text-right"><div className="font-bold text-indigo-600 text-sm">¥{((o.quantity * o.unitPrice)/10000).toFixed(2)}w</div><div className="text-xs text-gray-400">{o.quantity}吨</div></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
          );
      };

      return (
        <div className="flex justify-center items-center h-[calc(100vh-100px)] overflow-hidden bg-gray-100 p-4">
            <div className="relative w-[375px] h-[750px] bg-black rounded-[3rem] shadow-2xl border-8 border-gray-800 overflow-hidden shrink-0">
                <div className="w-full h-full bg-white pt-8 relative overflow-y-auto">
                    {view === 'home' && (
                        <div className="p-6 space-y-4">
                            <div className="bg-blue-600 h-32 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg mb-6">工厂 APP</div>
                            <button onClick={() => setView('todo-list')} className="w-full bg-white p-5 rounded-xl shadow-sm flex items-center gap-4 hover:shadow-md transition-all border border-gray-100 relative overflow-hidden">
                                <div className="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center text-red-500"><FileCheck size={24} /></div>
                                <div className="text-left flex-1"><h3 className="font-bold text-gray-800 text-lg">我的待办</h3><p className="text-gray-500 text-sm">审批、审核与确认事项</p></div>
                                {pendingTasks.length > 0 && <div className="absolute top-4 right-4 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-sm animate-pulse">{pendingTasks.length}</div>}
                            </button>
                            <button onClick={() => setView('stats')} className="w-full bg-white p-5 rounded-xl shadow-sm flex items-center gap-4 hover:shadow-md transition-all border border-gray-100">
                                <div className="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600"><PieChart size={24} /></div>
                                <div className="text-left"><h3 className="font-bold text-gray-800 text-lg">统计分析</h3><p className="text-gray-500 text-sm">查看经营数据日报</p></div>
                            </button>
                            <button onClick={() => { setFormData(INITIAL_FORM_DATA); setView('driver'); }} className="w-full bg-white p-5 rounded-xl shadow-sm flex items-center gap-4 hover:shadow-md transition-all border border-gray-100"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><User size={24} /></div><div className="text-left"><h3 className="font-bold text-gray-800 text-lg">驾驶员填报</h3><p className="text-gray-500 text-sm">硫酸卸货信息登记</p></div></button>
                            <button onClick={() => setView('staff-list')} className="w-full bg-white p-5 rounded-xl shadow-sm flex items-center gap-4 hover:shadow-md transition-all border border-gray-100"><div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><Shield size={24} /></div><div className="text-left"><h3 className="font-bold text-gray-800 text-lg">卸货查验核准</h3><p className="text-gray-500 text-sm">选择车辆进行安全检查</p></div></button>
                            <button onClick={() => setView('production')} className="w-full bg-white p-5 rounded-xl shadow-sm flex items-center gap-4 hover:shadow-md transition-all border border-gray-100"><div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><Factory size={24} /></div><div className="text-left"><h3 className="font-bold text-gray-800 text-lg">生产日报录入</h3><p className="text-gray-500 text-sm">每日产量与原料消耗</p></div></button>
                        </div>
                    )}
                    {view === 'todo-list' && <TodoListView />}
                    {view === 'stats' && <StatisticsView />}
                    {view === 'driver' && <DriverView />}
                    {view === 'staff-list' && <StaffListView />}
                    {view === 'staff-detail' && <StaffDetailView />}
                    {view === 'production' && <ProductionView />}
                </div>
            </div>
        </div>
      );
    };

    const App = () => {
       const [productionRecords, setProductionRecords] = useState([]);
       const [orders, setOrders] = useState(MOCK_ORDERS); 
       const [currentView, setCurrentView] = useState('app_simulation'); 

       // Derived pending tasks
       const pendingTasks = useMemo(() => {
          return orders.filter(o => o.status === OrderStatus.PendingAudit || o.status === OrderStatus.PriceApproval);
       }, [orders]);

       const handleSaveProduction = (records) => {
          setProductionRecords(prev => [...records, ...prev]);
       };

       // Mock approval handlers for standalone preview
       const handleApprove = (order) => {
          if(confirm('App模拟: 确认批准?')) {
             setOrders(prev => prev.map(o => o.id === order.id ? {...o, status: OrderStatus.Unassigned} : o));
          }
       };
       const handleReject = (order) => {
          if(confirm('App模拟: 确认驳回?')) {
             alert('已驳回');
          }
       };

       return (
         <div className="flex h-screen bg-gray-100">
            <div className="w-64 bg-slate-900 text-white p-4 space-y-2">
               <div className="font-bold text-lg mb-6">OrderFlow</div>
               <button onClick={() => setCurrentView('warehouse_view')} className="block w-full text-left p-2 hover:bg-slate-800 rounded">仓库概览</button>
               <button onClick={() => setCurrentView('warehouse_ops')} className="block w-full text-left p-2 hover:bg-slate-800 rounded">库存作业</button>
               <button onClick={() => setCurrentView('app_simulation')} className="block w-full text-left p-2 hover:bg-slate-800 rounded">APP 模拟</button>
            </div>
            <div className="flex-1 overflow-auto p-8">
               {currentView === 'warehouse_view' && <WarehouseOverview extraRecords={productionRecords} />}
               {currentView === 'warehouse_ops' && <WarehouseOperations onSaveRecord={handleSaveProduction} />}
               {currentView === 'app_simulation' && <AppSimulation onSaveProduction={handleSaveProduction} pendingTasks={pendingTasks} onApprove={handleApprove} onReject={handleReject} />}
            </div>
         </div>
       );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>